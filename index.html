<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30ì¸ ê¸°ë¡ ì¸¡ì • ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; }
        select, button, input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #333; color: white; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #555; }
        button.save-btn { background-color: #007bff; border-color: #007bff; }
        button.save-btn:hover { background-color: #0056b3; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { background-color: #333; color: white; cursor: pointer; user-select: none; position: sticky; top: 0; }
        th:hover { background-color: #555; }
        
        /* íŒ€ ìƒ‰ìƒ */
        .team-purple { border-left: 5px solid #800080; background-color: #fcf0fc; }
        .team-green { border-left: 5px solid #008000; background-color: #f0fcf0; }
        .team-yellow { border-left: 5px solid #DAA520; background-color: #fcfcf0; }
        .team-blue { border-left: 5px solid #0000FF; background-color: #f0f0fc; }
        .team-red { border-left: 5px solid #FF0000; background-color: #fcf0f0; }
        .team-brown { border-left: 5px solid #A52A2A; background-color: #fcf5f0; }

        /* ê´€ë¦¬ì íŒ¨ë„ */
        #adminPanel { display: none; border: 2px solid #333; padding: 20px; margin-top: 20px; background: #fff; border-radius: 8px; }
        .section-title { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; color: #333; }
        .input-group { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        /* ì¢…ëª© ì´ë¦„ ìˆ˜ì • ê·¸ë¦¬ë“œ */
        .event-name-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px; }
        .event-name-grid input { width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <h1>ğŸ† ê¸°ë¡ ì¸¡ì • ëŒ€ì‹œë³´ë“œ</h1>

    <div class="controls">
        <label>ğŸ“… ì£¼ì°¨ ì„ íƒ: </label>
        <select id="weekSelect" onchange="loadData()">
            <option value="week1">1ì£¼ì°¨</option>
            <option value="week2">2ì£¼ì°¨</option>
            <option value="week3">3ì£¼ì°¨</option>
            <option value="week4">4ì£¼ì°¨</option>
            <option value="week5">5ì£¼ì°¨</option>
        </select>
        <button onclick="toggleAdmin()">âš™ï¸ ê´€ë¦¬ì ëª¨ë“œ (ë°ì´í„°/ì´ë¦„ ë³€ê²½)</button>
    </div>

    <div class="table-container">
        <table id="recordTable">
            <thead>
                <tr id="tableHeaderRow">
                    </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="13" style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="adminPanel">
        
        <div class="section-title">ğŸ› ï¸ ì¢…ëª© ì´ë¦„ ë³€ê²½ (12ê°œ)</div>
        <p style="font-size: 0.9em; color: #666;">ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ë°”ê¾¸ê³  ì €ì¥ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”. ëª¨ë“  ì£¼ì°¨ì— ê³µí†µìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.</p>
        <div class="event-name-grid" id="eventNameInputs">
            </div>
        <button class="save-btn" onclick="saveEventNames()">ì¢…ëª© ì´ë¦„ ì €ì¥í•˜ê¸°</button>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ddd;">

        <div class="section-title">ğŸ“ ì„ ìˆ˜ ê¸°ë¡ ì…ë ¥/ìˆ˜ì •</div>
        <div class="input-group">
            <input type="text" id="inputName" placeholder="ì´ë¦„ (ì˜ˆ: ê¹€ì² ìˆ˜)">
            <select id="inputTeam">
                <option value="purple">ë³´ë¼íŒ€</option>
                <option value="green">ì´ˆë¡íŒ€</option>
                <option value="yellow">ë…¸ë‘íŒ€</option>
                <option value="blue">íŒŒë‘íŒ€</option>
                <option value="red">ë¹¨ê°•íŒ€</option>
                <option value="brown">ê°ˆìƒ‰íŒ€</option>
            </select>
        </div>
        <div class="input-group">
            <select id="inputEventSelect">
                </select>
            <input type="text" id="inputRecord" placeholder="ê¸°ë¡ (ìˆ«ì ë˜ëŠ” RETIRE)">
            <button class="save-btn" onclick="saveRecord()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
        </div>
        <p style="font-size: 0.8em; color: gray;">* ê¸°ë¡ì„ ë¹„ì›Œë‘ë©´ "ë¯¸ì°¸ì—¬(-)" ì²˜ë¦¬ë©ë‹ˆë‹¤. RETIREëŠ” ëŒ€ë¬¸ìë¡œ ì…ë ¥í•˜ì„¸ìš”.</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ì‚¬ìš©ì Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
            authDomain: "bsar5-d7818.firebaseapp.com",
            databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
            projectId: "bsar5-d7818",
            storageBucket: "bsar5-d7818.firebasestorage.app",
            messagingSenderId: "377629207721",
            appId: "1:377629207721:web:8b893496c0ac1749890db8",
            measurementId: "G-M9FJXYTS3F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ê¸°ë³¸ê°’ (DBì— ì´ë¦„ì´ ì—†ì„ ë•Œ ì‚¬ìš©)
        let eventNames = [
            "ì¢…ëª© 1", "ì¢…ëª© 2", "ì¢…ëª© 3", "ì¢…ëª© 4", "ì¢…ëª© 5", "ì¢…ëª© 6",
            "ì¢…ëª© 7", "ì¢…ëª© 8", "ì¢…ëª© 9", "ì¢…ëª© 10", "ì¢…ëª© 11", "ì¢…ëª© 12"
        ];
        
        let currentData = [];
        let currentWeek = "week1";

        // ì „ì—­ í•¨ìˆ˜ ì—°ê²°
        window.loadData = loadData;
        window.saveRecord = saveRecord;
        window.toggleAdmin = toggleAdmin;
        window.sortTable = sortTable;
        window.saveEventNames = saveEventNames;

        // ==========================================
        // 1. ì´ˆê¸°í™” ë¡œì§ (ì¢…ëª© ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸° -> UI ê·¸ë¦¬ê¸° -> ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°)
        // ==========================================
        async function initApp() {
            await loadEventNames(); // DBì—ì„œ ì¢…ëª© ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            renderUI();             // ê°€ì ¸ì˜¨ ì´ë¦„ìœ¼ë¡œ í™”ë©´ ê·¸ë¦¬ê¸°
            loadData();             // ì„ ìˆ˜ ê¸°ë¡ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        }

        // ì¢…ëª© ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadEventNames() {
            const docRef = doc(db, "settings", "eventNames"); // 'settings' ì»¬ë ‰ì…˜ì˜ 'eventNames' ë¬¸ì„œ
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                eventNames = docSnap.data().names; // DBì— ì €ì¥ëœ ì´ë¦„ìœ¼ë¡œ êµì²´
            }
            // ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ìœ ì§€
        }

        // í™”ë©´ ê·¸ë¦¬ê¸° (í…Œì´ë¸” í—¤ë”, ì…ë ¥ì°½ ì˜µì…˜, ê´€ë¦¬ì ì´ë¦„ ë³€ê²½ì°½)
        function renderUI() {
            // A. í…Œì´ë¸” í—¤ë”
            const headerRow = document.getElementById('tableHeaderRow');
            let headerHTML = `<th onclick="sortTable('name')">ì´ë¦„ (íŒ€)</th>`;
            eventNames.forEach((name, index) => {
                headerHTML += `<th onclick="sortTable('event${index + 1}')">${name}</th>`;
            });
            headerRow.innerHTML = headerHTML;

            // B. ê¸°ë¡ ì…ë ¥ìš© ë“œë¡­ë‹¤ìš´
            const selectBox = document.getElementById('inputEventSelect');
            let optionsHTML = "";
            eventNames.forEach((name, index) => {
                optionsHTML += `<option value="event${index + 1}">${name}</option>`;
            });
            selectBox.innerHTML = optionsHTML;

            // C. ê´€ë¦¬ì ì¢…ëª© ì´ë¦„ ë³€ê²½ ì¸í’‹ë°•ìŠ¤ 12ê°œ ìƒì„±
            const nameEditor = document.getElementById('eventNameInputs');
            let inputsHTML = "";
            eventNames.forEach((name, index) => {
                inputsHTML += `<input type="text" id="eventNameEdit${index}" value="${name}" placeholder="ì¢…ëª© ${index+1}">`;
            });
            nameEditor.innerHTML = inputsHTML;
        }

        // ==========================================
        // 2. ì¢…ëª© ì´ë¦„ ì €ì¥ (ê´€ë¦¬ì ê¸°ëŠ¥)
        // ==========================================
        async function saveEventNames() {
            const newNames = [];
            for (let i = 0; i < 12; i++) {
                const val = document.getElementById(`eventNameEdit${i}`).value;
                newNames.push(val || `ì¢…ëª© ${i+1}`); // ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’
            }

            if (!confirm("ì¢…ëª© ì´ë¦„ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì£¼ì°¨ì— ë°˜ì˜ë©ë‹ˆë‹¤.")) return;

            // DBì— ì €ì¥
            await setDoc(doc(db, "settings", "eventNames"), {
                names: newNames
            });

            eventNames = newNames; // ë©”ëª¨ë¦¬ ìƒ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            renderUI(); // í™”ë©´ ì¦‰ì‹œ ê°±ì‹  (ìƒˆë¡œê³ ì¹¨ ë¶ˆí•„ìš”)
            alert("ì¢…ëª© ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        // ==========================================
        // 3. ì„ ìˆ˜ ë°ì´í„° ê´€ë¦¬
        // ==========================================
        async function loadData() {
            const weekSelect = document.getElementById('weekSelect');
            currentWeek = weekSelect.value;
            const tableBody = document.getElementById('tableBody');
            
            // ë¡œë”© ì¤‘ í‘œì‹œ (ì—´ ê°œìˆ˜ì— ë§ì¶° colspan ì¡°ì •)
            tableBody.innerHTML = '<tr><td colspan="13" style="text-align:center; padding: 20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

            const querySnapshot = await getDocs(collection(db, currentWeek));
            currentData = [];

            querySnapshot.forEach((doc) => {
                currentData.push(doc.data());
            });

            currentData.sort((a, b) => a.name.localeCompare(b.name));
            renderTable(currentData);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = "";

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="13" style="text-align:center; padding: 20px; color: #888;">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì ëª¨ë“œì—ì„œ ì¶”ê°€í•´ì£¼ì„¸ìš”.</td></tr>';
                return;
            }

            data.forEach(person => {
                let row = `<tr>`;
                row += `<td class="team-${person.team}">${person.name}</td>`;
                
                for(let i=1; i<=12; i++) {
                    let record = person[`event${i}`] || "-";
                    row += `<td>${record}</td>`;
                }
                row += `</tr>`;
                tableBody.innerHTML += row;
            });
        }

        async function saveRecord() {
            const name = document.getElementById('inputName').value.trim();
            const team = document.getElementById('inputTeam').value;
            const event = document.getElementById('inputEventSelect').value;
            let record = document.getElementById('inputRecord').value.trim();

            if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            if (record === "") {
                record = null; // ë¹ˆì¹¸ì€ ì‚­ì œ ì²˜ë¦¬
            } else if (record.toUpperCase() === "RETIRE") {
                record = "RETIRE";
            } else {
                if(!isNaN(record)) {
                    record = parseFloat(record).toFixed(2);
                } else {
                    return alert("ìˆ«ì ë˜ëŠ” RETIREë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                }
            }

            const docRef = doc(db, currentWeek, name);
            const docSnap = await getDoc(docRef);
            
            let newData = {};
            if (docSnap.exists()) {
                newData = docSnap.data();
            }

            newData.name = name;
            newData.team = team;
            
            if (record === null) {
                delete newData[event];
            } else {
                newData[event] = record;
            }

            await setDoc(docRef, newData);
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            loadData();
        }

        function sortTable(key) {
            if (key === 'name') {
                currentData.sort((a, b) => a.name.localeCompare(b.name));
            } else {
                currentData.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];

                    if (!valA) return 1; 
                    if (!valB) return -1;

                    if (valA === "RETIRE") return 1;
                    if (valB === "RETIRE") return -1;
                    if (valA === "RETIRE" && valB === "RETIRE") return 0;

                    return parseFloat(valA) - parseFloat(valB);
                });
            }
            renderTable(currentData);
        }

        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // ì•± ì‹¤í–‰
        initApp();
    </script>
</body>
</html>