<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30ì¸ ê¸°ë¡ ì¸¡ì • ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; }
        select, button, input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #333; color: white; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #555; }
        button.save-btn { background-color: #007bff; border-color: #007bff; }
        button.save-btn:hover { background-color: #0056b3; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; }
        th { background-color: #333; color: white; cursor: pointer; user-select: none; position: sticky; top: 0; }
        th:hover { background-color: #555; }
        
        /* íŒ€ ìƒ‰ìƒ ìŠ¤íƒ€ì¼ */
        .team-purple { border-left: 5px solid #800080; background-color: #fcf0fc; color: #800080; font-weight: bold; }
        .team-green { border-left: 5px solid #008000; background-color: #f0fcf0; color: #008000; font-weight: bold; }
        .team-yellow { border-left: 5px solid #DAA520; background-color: #fcfcf0; color: #DAA520; font-weight: bold; }
        .team-blue { border-left: 5px solid #0000FF; background-color: #f0f0fc; color: #0000FF; font-weight: bold; }
        .team-red { border-left: 5px solid #FF0000; background-color: #fcf0f0; color: #FF0000; font-weight: bold; }
        .team-brown { border-left: 5px solid #A52A2A; background-color: #fcf5f0; color: #A52A2A; font-weight: bold; }

        /* ê´€ë¦¬ì íŒ¨ë„ */
        #adminPanel { display: none; border: 2px solid #333; padding: 20px; margin-top: 20px; background: #fff; border-radius: 8px; }
        .section-title { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; color: #333; }
        .input-group { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    </style>
</head>
<body>

    <h1>ğŸ† 30ì¸ ê¸°ë¡ ì¸¡ì • ëŒ€ì‹œë³´ë“œ</h1>

    <div class="controls">
        <label>ğŸ“… ì£¼ì°¨ ì„ íƒ: </label>
        <select id="weekSelect" onchange="loadData()">
            <option value="week1">1ì£¼ì°¨</option>
            <option value="week2">2ì£¼ì°¨</option>
            <option value="week3">3ì£¼ì°¨</option>
            <option value="week4">4ì£¼ì°¨</option>
            <option value="week5">5ì£¼ì°¨</option>
        </select>
        <button onclick="toggleAdmin()">âš™ï¸ ê´€ë¦¬ì ëª¨ë“œ (ê¸°ë¡ ì…ë ¥)</button>
    </div>

    <div class="table-container">
        <table id="recordTable">
            <thead>
                <tr id="tableHeaderRow">
                    </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="13" style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="adminPanel">
        <div class="section-title">ğŸ“ ì„ ìˆ˜ ê¸°ë¡ ì…ë ¥/ìˆ˜ì •</div>
        <div class="input-group">
            <select id="inputNameSelect">
                <option value="">ì„ ìˆ˜ ì„ íƒ</option>
            </select>
            
            <select id="inputEventSelect">
                </select>

            <input type="text" id="inputRecord" placeholder="ê¸°ë¡ (ìˆ«ì ë˜ëŠ” RETIRE)">
            <button class="save-btn" onclick="saveRecord()">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
        </div>
        <p style="font-size: 0.8em; color: gray;">
            * 30ëª…ì˜ ì´ë¦„ì´ ë¯¸ë¦¬ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê¸°ë¡ì„ ì…ë ¥í•  ì„ ìˆ˜ë¥¼ ëª©ë¡ì—ì„œ ì„ íƒí•˜ì„¸ìš”.<br>
            * ê¸°ë¡ì´ ì—†ëŠ” ì„ ìˆ˜ëŠ” ìë™ìœ¼ë¡œ í•˜ìœ„ê¶Œ(ë¹ˆì¹¸) ì²˜ë¦¬ë©ë‹ˆë‹¤.
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // âœ… [ì„¤ì • 1] ì¢…ëª© ì´ë¦„ ê³ ì • (12ê°œ)
        const eventNames = [
            "ë³¼íŠ¸ì™€ ë„ˆíŠ¸", "ì—­ìŒê·¼", "ì›Œë“œë©”ì´ì»¤", "ë°˜ì‚¬ê²Œì„", 
            "ë¬´ìŠ¹ë¶€ ì‚¬ëª©", "ë„˜ë²„ ì²´ì¸", "ë¬¼ìš©ëŸ‰", "ê´´ë¬¼ í¼ì¦", 
            "ë”ìƒ‰ë†€", "13ê°„ì§€", "í•œìˆ˜ì²´í¬", "ë‚˜ë¬´ìœ„í‚¤"
        ];

        // âœ… [ì„¤ì • 2] ì°¸ê°€ì 30ëª… ëª…ë‹¨ (ë³´ë¼, ì´ˆë¡, ë…¸ë‘, íŒŒë‘, ë¹¨ê°•, ê°ˆìƒ‰)
        const defaultPlayers = [
            // ë³´ë¼ìƒ‰
            { name: "GMT_ê³¼ë°•", team: "purple" }, { name: "GMT_ë‘ì›”", team: "purple" }, 
            { name: "GMT_ìµëª…", team: "purple" }, { name: "GMT_ì°Œë†", team: "purple" }, { name: "GMT_í›„ì¥", team: "purple" },
            // ì´ˆë¡ìƒ‰
            { name: "GS3_ê²Œë¡œ", team: "green" }, { name: "GS3_ì°½ì¡°", team: "green" }, 
            { name: "GS3_ë„´ë¦¬", team: "green" }, { name: "GS3_ì§í”Œ", team: "green" }, { name: "GS3_ì„œì§„", team: "green" },
            // ë…¸ë‘ìƒ‰
            { name: "B1A4_ìš´ëª…", team: "yellow" }, { name: "B1A4_ëŸ¬ê°", team: "yellow" }, 
            { name: "B1A4_ì†Œë„¤", team: "yellow" }, { name: "B1A4_ìš°ìœ ", team: "yellow" }, { name: "B1A4_ì§‘ê°€", team: "yellow" },
            // íŒŒë‘ìƒ‰
            { name: "DBT_ëª¨ì§€", team: "blue" }, { name: "DBT_ë¡œë‹ˆ", team: "blue" }, 
            { name: "DBT_ì‚¬ë¥´", team: "blue" }, { name: "DBT_ì§€ë‹ˆ", team: "blue" }, { name: "DBT_í‹°í‹°", team: "blue" },
            // ë¹¨ê°•ìƒ‰
            { name: "HTML_í•˜ë©œ", team: "red" }, { name: "HTML_ê·¤ê¹Œ", team: "red" }, 
            { name: "HTML_ë¬´í˜¼", team: "red" }, { name: "HTML_í‘ë‘", team: "red" }, { name: "HTML_ì—˜ì œ", team: "red" },
            // ê°ˆìƒ‰
            { name: "BLS_í•œë¹ˆ", team: "brown" }, { name: "BLS_ë„ê°", team: "brown" }, 
            { name: "BLS_ë¬¸ìŠ¤", team: "brown" }, { name: "BLS_ë¸”ìŠ¤", team: "brown" }, { name: "BLS_ì„­ì¢€", team: "brown" }
        ];

        // Firebase ì„¤ì • (ë‹˜ ì„¤ì •ê°’)
        const firebaseConfig = {
            apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
            authDomain: "bsar5-d7818.firebaseapp.com",
            databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
            projectId: "bsar5-d7818",
            storageBucket: "bsar5-d7818.firebasestorage.app",
            messagingSenderId: "377629207721",
            appId: "1:377629207721:web:8b893496c0ac1749890db8",
            measurementId: "G-M9FJXYTS3F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentData = [];
        let currentWeek = "week1";

        window.loadData = loadData;
        window.saveRecord = saveRecord;
        window.toggleAdmin = toggleAdmin;
        window.sortTable = sortTable;

        // ì´ˆê¸°í™”
        function initUI() {
            // 1. í…Œì´ë¸” í—¤ë” ìƒì„±
            const headerRow = document.getElementById('tableHeaderRow');
            let headerHTML = `<th onclick="sortTable('name')">ì´ë¦„ (íŒ€)</th>`;
            eventNames.forEach((name, index) => {
                headerHTML += `<th onclick="sortTable('event${index + 1}')">${name}</th>`;
            });
            headerRow.innerHTML = headerHTML;

            // 2. ì…ë ¥ì°½ ì¢…ëª© ì„ íƒ ìƒì„±
            const selectBox = document.getElementById('inputEventSelect');
            let optionsHTML = "";
            eventNames.forEach((name, index) => {
                optionsHTML += `<option value="event${index + 1}">${name}</option>`;
            });
            selectBox.innerHTML = optionsHTML;

            // 3. ì…ë ¥ì°½ ì„ ìˆ˜ ì„ íƒ ìƒì„± (30ëª…)
            const nameSelect = document.getElementById('inputNameSelect');
            let nameOptions = `<option value="">ì„ ìˆ˜ ì„ íƒ</option>`;
            defaultPlayers.forEach(p => {
                nameOptions += `<option value="${p.name}">${p.name} (${p.team})</option>`;
            });
            nameSelect.innerHTML = nameOptions;
        }

        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadData() {
            const weekSelect = document.getElementById('weekSelect');
            currentWeek = weekSelect.value;
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="13" style="text-align:center; padding: 20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

            const querySnapshot = await getDocs(collection(db, currentWeek));
            let dbData = [];
            querySnapshot.forEach((doc) => {
                dbData.push(doc.data());
            });

            // ë°ì´í„° ë³‘í•© ë¡œì§: DBì— ë°ì´í„°ê°€ ìˆë“  ì—†ë“  30ëª… ê¸°ë³¸ ëª…ë‹¨ì„ ë¼ˆëŒ€ë¡œ ì‚¬ìš©
            // ì´ë ‡ê²Œ í•´ì•¼ ì•„ì§ ê¸°ë¡ì´ ì—†ëŠ” ì‚¬ëŒë„ ëª©ë¡ì— í‘œì‹œë¨
            currentData = defaultPlayers.map(player => {
                // DBì—ì„œ ê°™ì€ ì´ë¦„ì„ ê°€ì§„ ì‚¬ëŒ ì°¾ê¸°
                const record = dbData.find(d => d.name === player.name);
                if (record) {
                    return { ...player, ...record }; // DB ê¸°ë¡ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°
                } else {
                    return player; // ì—†ìœ¼ë©´ ê¸°ë³¸ ì •ë³´ë§Œ ì‚¬ìš©
                }
            });

            // ì´ˆê¸° ì •ë ¬: íŒ€ ìˆœì„œëŒ€ë¡œ (defaultPlayers ë°°ì—´ ìˆœì„œ ìœ ì§€)
            // ë³„ë„ì˜ ì •ë ¬ ì—†ì´ map ìˆœì„œ ê·¸ëŒ€ë¡œ ë‘ë©´ ë³´ë¼->ì´ˆë¡->ë…¸ë‘... ìˆœìœ¼ë¡œ ë‚˜ì˜´
            renderTable(currentData);
        }

        // í…Œì´ë¸” ë Œë”ë§
        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = "";

            data.forEach(person => {
                let row = `<tr>`;
                row += `<td class="team-${person.team}">${person.name}</td>`;
                
                for(let i=1; i<=12; i++) {
                    let record = person[`event${i}`] || "-";
                    row += `<td>${record}</td>`;
                }
                row += `</tr>`;
                tableBody.innerHTML += row;
            });
        }

        // ì •ë ¬
        function sortTable(key) {
            if (key === 'name') {
                // ì´ë¦„ ì •ë ¬ (ê°€ë‚˜ë‹¤ìˆœ)
                currentData.sort((a, b) => a.name.localeCompare(b.name));
            } else {
                // ê¸°ë¡ ì •ë ¬
                currentData.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];
                    
                    // ê°’ ì—†ìŒ(ë¯¸ì°¸ì—¬)ì€ ë§¨ ë’¤ë¡œ
                    if (!valA) return 1; 
                    if (!valB) return -1;
                    
                    // RETIREëŠ” ìˆ«ì ë’¤, ë¯¸ì°¸ì—¬ ì• (ì—¬ê¸°ì„  í° ìˆ«ìë¡œ ì·¨ê¸‰)
                    if (valA === "RETIRE") return 1;
                    if (valB === "RETIRE") return -1;
                    if (valA === "RETIRE" && valB === "RETIRE") return 0;
                    
                    // ìˆ«ìëŠ” ì˜¤ë¦„ì°¨ìˆœ (ì‘ì€ ê²Œ 1ë“±)
                    return parseFloat(valA) - parseFloat(valB);
                });
            }
            renderTable(currentData);
        }

        // ì €ì¥
        async function saveRecord() {
            const name = document.getElementById('inputNameSelect').value;
            const event = document.getElementById('inputEventSelect').value;
            let record = document.getElementById('inputRecord').value.trim();

            if (!name) return alert("ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

            // íŒ€ ìƒ‰ìƒ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const playerInfo = defaultPlayers.find(p => p.name === name);
            const team = playerInfo ? playerInfo.team : "brown";

            if (record === "") {
                record = null;
            } else if (record.toUpperCase() === "RETIRE") {
                record = "RETIRE";
            } else {
                if(!isNaN(record)) {
                    record = parseFloat(record).toFixed(2);
                } else {
                    return alert("ìˆ«ì ë˜ëŠ” RETIREë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                }
            }

            const docRef = doc(db, currentWeek, name);
            const docSnap = await getDoc(docRef);
            
            let newData = {};
            if (docSnap.exists()) {
                newData = docSnap.data();
            } else {
                newData = { name: name, team: team };
            }

            newData.team = team;

            if (record === null) {
                delete newData[event];
            } else {
                newData[event] = record;
            }

            await setDoc(docRef, newData);
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            loadData();
        }

        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        initUI();
        loadData();
    </script>
</body>
</html>