<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>30ì¸ ê¸°ë¡ ì¸¡ì • ëŒ€ì‹œë³´ë“œ</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f4f4f9; }
        h1 { text-align: center; }
        
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .controls { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; align-items: center; }
        select, button, input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #333; color: white; cursor: pointer; transition: 0.2s; }
        button:hover { background-color: #555; }
        button.save-btn { background-color: #007bff; border-color: #007bff; }
        button.save-btn:hover { background-color: #0056b3; }
        button.reset-btn { background-color: #dc3545; border-color: #dc3545; } /* ì´ˆê¸°í™” ë²„íŠ¼ ìƒ‰ìƒ */
        button.reset-btn:hover { background-color: #c82333; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1400px; } /* border-collapse: separate í•„ìš” (sticky ë•Œë¬¸) */
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; border-right: 1px solid #eee; }
        
        /* í—¤ë” ê³ ì • (ìƒë‹¨) */
        th { background-color: #333; color: white; user-select: none; position: sticky; top: 0; z-index: 20; }
        
        /* ì´ë¦„ ì»¬ëŸ¼ ê³ ì • (ì¢Œì¸¡) - í•µì‹¬ ê¸°ëŠ¥ */
        .sticky-col { 
            position: sticky; 
            left: 0; 
            z-index: 30; /* í—¤ë”ë³´ë‹¤ ìœ„, ë°ì´í„°ë³´ë‹¤ ìœ„ */
            background-color: #fff; /* íˆ¬ëª…í•˜ë©´ ë’¤ì— ê¸€ì”¨ ë¹„ì¹¨ ë°©ì§€ */
            border-right: 2px solid #ddd;
        }
        th.sticky-col { z-index: 40; background-color: #333; } /* ì™¼ìª½ ìƒë‹¨ ì½”ë„ˆëŠ” ìµœìƒë‹¨ */

        /* íŒ€ ìƒ‰ìƒ ìŠ¤íƒ€ì¼ (ì´ë¦„ ë°°ê²½ìƒ‰) */
        .team-purple { border-left: 5px solid #800080; background-color: #fcf0fc; color: #800080; font-weight: bold; }
        .team-green { border-left: 5px solid #008000; background-color: #f0fcf0; color: #008000; font-weight: bold; }
        .team-yellow { border-left: 5px solid #DAA520; background-color: #fcfcf0; color: #DAA520; font-weight: bold; }
        .team-blue { border-left: 5px solid #0000FF; background-color: #f0f0fc; color: #0000FF; font-weight: bold; }
        .team-red { border-left: 5px solid #FF0000; background-color: #fcf0f0; color: #FF0000; font-weight: bold; }
        .team-brown { border-left: 5px solid #A52A2A; background-color: #fcf5f0; color: #A52A2A; font-weight: bold; }

        /* ê´€ë¦¬ì íŒ¨ë„ */
        #adminPanel { display: none; border: 2px solid #333; padding: 20px; margin-top: 20px; background: #fff; border-radius: 8px; }
        .input-group { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        /* ì´ë™ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .move-btn {
            background: none; border: none; color: #aaa; cursor: pointer; font-size: 10px; padding: 0 2px;
        }
        .move-btn:hover { color: #fff; }
        .th-content { display: flex; align-items: center; justify-content: center; gap: 5px; }
    </style>
</head>
<body>

    <h1>ğŸ† 30ì¸ ê¸°ë¡ ì¸¡ì • ëŒ€ì‹œë³´ë“œ</h1>

    <div class="controls">
        <label>ğŸ“… ì£¼ì°¨ ì„ íƒ: </label>
        <select id="weekSelect" onchange="loadData()">
            <option value="week1">1ì£¼ì°¨</option>
            <option value="week2">2ì£¼ì°¨</option>
            <option value="week3">3ì£¼ì°¨</option>
            <option value="week4">4ì£¼ì°¨</option>
            <option value="week5">5ì£¼ì°¨</option>
        </select>
        <button class="reset-btn" onclick="resetOrder()">â†º ì¢…ëª© ìˆœì„œ ì´ˆê¸°í™”</button>
        <button onclick="toggleAdmin()">âš™ï¸ ê´€ë¦¬ì ëª¨ë“œ</button>
    </div>

    <div class="table-container">
        <table id="recordTable">
            <thead>
                <tr id="tableHeaderRow">
                    </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="13" style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="adminPanel">
        <h3>ğŸ“ ê¸°ë¡ ì…ë ¥</h3>
        <div class="input-group">
            <select id="inputNameSelect">
                <option value="">ì„ ìˆ˜ ì„ íƒ</option>
            </select>
            <select id="inputEventSelect">
                </select>
            <input type="text" id="inputRecord" placeholder="ê¸°ë¡ (ì—”í„°í‚¤ë¡œ ì €ì¥)" onkeydown="if(window.event.keyCode == 13){ saveRecord(); }">
            <button class="save-btn" onclick="saveRecord()">ì €ì¥</button>
        </div>
        <p style="font-size: 0.8em; color: gray;">
            * <b>ì—”í„°(Enter)</b>ë¥¼ ëˆ„ë¥´ë©´ ë°”ë¡œ ì €ì¥ë©ë‹ˆë‹¤.<br>
            * ì…ë ¥ì°½ì€ ìë™ìœ¼ë¡œ ë¹„ì›Œì§‘ë‹ˆë‹¤.
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // âœ… ì¢…ëª© ì´ë¦„ ê³ ì •
        const eventNames = [
            "ë³¼íŠ¸ì™€ ë„ˆíŠ¸", "ì—­ìŒê·¼", "ì›Œë“œë©”ì´ì»¤", "ë°˜ì‚¬ê²Œì„", 
            "ë¬´ìŠ¹ë¶€ ì‚¬ëª©", "ë„˜ë²„ ì²´ì¸", "ë¬¼ìš©ëŸ‰", "ê´´ë¬¼ í¼ì¦", 
            "ë”ìƒ‰ë†€", "13ê°„ì§€", "í•œìˆ˜ì²´í¬", "ë‚˜ë¬´ìœ„í‚¤"
        ];

        // í™”ë©´ì— ë³´ì—¬ì§ˆ ì¢…ëª© ìˆœì„œ (ì¸ë±ìŠ¤ 0~11)
        let eventOrder = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];

        // âœ… ì°¸ê°€ì ëª…ë‹¨
        const defaultPlayers = [
            { name: "GMT_ê³¼ë°•", team: "purple" }, { name: "GMT_ë‘ì›”", team: "purple" }, { name: "GMT_ìµëª…", team: "purple" }, { name: "GMT_ì°Œë†", team: "purple" }, { name: "GMT_í›„ì¥", team: "purple" },
            { name: "GS3_ê²Œë¡œ", team: "green" }, { name: "GS3_ì°½ì¡°", team: "green" }, { name: "GS3_ë„´ë¦¬", team: "green" }, { name: "GS3_ì§í”Œ", team: "green" }, { name: "GS3_ì„œì§„", team: "green" },
            { name: "B1A4_ìš´ëª…", team: "yellow" }, { name: "B1A4_ëŸ¬ê°", team: "yellow" }, { name: "B1A4_ì†Œë„¤", team: "yellow" }, { name: "B1A4_ìš°ìœ ", team: "yellow" }, { name: "B1A4_ì§‘ê°€", team: "yellow" },
            { name: "DBT_ëª¨ì§€", team: "blue" }, { name: "DBT_ë¡œë‹ˆ", team: "blue" }, { name: "DBT_ì‚¬ë¥´", team: "blue" }, { name: "DBT_ì§€ë‹ˆ", team: "blue" }, { name: "DBT_í‹°í‹°", team: "blue" },
            { name: "HTML_í•˜ë©œ", team: "red" }, { name: "HTML_ê·¤ê¹Œ", team: "red" }, { name: "HTML_ë¬´í˜¼", team: "red" }, { name: "HTML_í‘ë‘", team: "red" }, { name: "HTML_ì—˜ì œ", team: "red" },
            { name: "BLS_í•œë¹ˆ", team: "brown" }, { name: "BLS_ë„ê°", team: "brown" }, { name: "BLS_ë¬¸ìŠ¤", team: "brown" }, { name: "BLS_ë¸”ìŠ¤", team: "brown" }, { name: "BLS_ì„­ì¢€", team: "brown" }
        ];

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDP7WJoqi9hWXO27KaeY9Lvitj-5-E0j5Y",
            authDomain: "bsar5-d7818.firebaseapp.com",
            databaseURL: "https://bsar5-d7818-default-rtdb.firebaseio.com",
            projectId: "bsar5-d7818",
            storageBucket: "bsar5-d7818.firebasestorage.app",
            messagingSenderId: "377629207721",
            appId: "1:377629207721:web:8b893496c0ac1749890db8",
            measurementId: "G-M9FJXYTS3F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentData = [];
        let currentWeek = "week1";

        // ì „ì—­ í•¨ìˆ˜ ì—°ê²°
        window.loadData = loadData;
        window.saveRecord = saveRecord;
        window.toggleAdmin = toggleAdmin;
        window.sortTable = sortTable;
        window.moveColumn = moveColumn;
        window.resetOrder = resetOrder;

        function initUI() {
            renderHeader(); // í—¤ë” ê·¸ë¦¬ê¸° (ìˆœì„œ ë°˜ì˜)
            
            // ê´€ë¦¬ì íŒ¨ë„ìš© ë“œë¡­ë‹¤ìš´ ìƒì„± (ê³ ì • ìˆœì„œ)
            const selectBox = document.getElementById('inputEventSelect');
            let optionsHTML = "";
            eventNames.forEach((name, index) => {
                optionsHTML += `<option value="event${index + 1}">${name}</option>`;
            });
            selectBox.innerHTML = optionsHTML;

            const nameSelect = document.getElementById('inputNameSelect');
            let nameOptions = `<option value="">ì„ ìˆ˜ ì„ íƒ</option>`;
            defaultPlayers.forEach(p => {
                nameOptions += `<option value="${p.name}">${p.name} (${p.team})</option>`;
            });
            nameSelect.innerHTML = nameOptions;
        }

        // 1. í—¤ë” ê·¸ë¦¬ê¸° (ìˆœì„œ ë³€ê²½ ê¸°ëŠ¥ í¬í•¨)
        function renderHeader() {
            const headerRow = document.getElementById('tableHeaderRow');
            let headerHTML = `<th class="sticky-col" onclick="sortTable('name')">ì´ë¦„ (íŒ€)</th>`;
            
            // eventOrder ë°°ì—´ ìˆœì„œëŒ€ë¡œ í—¤ë”ë¥¼ ìƒì„±
            eventOrder.forEach((originalIndex, displayIndex) => {
                // ì›ë˜ ì¸ë±ìŠ¤(0~11)ë¥¼ ì´ìš©í•´ event1 ~ event12 í‚¤ë¥¼ ì°¾ìŒ
                let eventKey = `event${originalIndex + 1}`;
                let name = eventNames[originalIndex];

                headerHTML += `
                    <th>
                        <div class="th-content">
                            ${displayIndex > 0 ? `<button class="move-btn" onclick="moveColumn(${displayIndex}, -1)">â—€</button>` : ''}
                            <span onclick="sortTable('${eventKey}')" style="cursor:pointer">${name}</span>
                            ${displayIndex < 11 ? `<button class="move-btn" onclick="moveColumn(${displayIndex}, 1)">â–¶</button>` : ''}
                        </div>
                    </th>
                `;
            });
            headerRow.innerHTML = headerHTML;
        }

        // 2. ì»¬ëŸ¼ ì´ë™ í•¨ìˆ˜
        function moveColumn(index, direction) {
            // ë°°ì—´ ë‚´ ìœ„ì¹˜ êµí™˜ (Swap)
            let temp = eventOrder[index];
            eventOrder[index] = eventOrder[index + direction];
            eventOrder[index + direction] = temp;
            
            // ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            renderHeader();
            renderTable(currentData);
        }

        // 3. ìˆœì„œ ì´ˆê¸°í™” í•¨ìˆ˜
        function resetOrder() {
            eventOrder = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11];
            renderHeader();
            renderTable(currentData);
        }

        async function loadData() {
            const weekSelect = document.getElementById('weekSelect');
            currentWeek = weekSelect.value;
            const tableBody = document.getElementById('tableBody');
            
            const dbRef = ref(db);
            get(child(dbRef, currentWeek)).then((snapshot) => {
                let dbData = [];
                if (snapshot.exists()) {
                    dbData = Object.values(snapshot.val());
                }

                currentData = defaultPlayers.map(player => {
                    const record = dbData.find(d => d.name === player.name);
                    return record ? { ...player, ...record } : player;
                });

                renderTable(currentData);

            }).catch((error) => {
                console.error(error);
                tableBody.innerHTML = '<tr><td colspan="13" style="text-align:center; padding: 20px;">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</td></tr>';
            });
        }

        // 4. í…Œì´ë¸” ë°ì´í„° ê·¸ë¦¬ê¸° (ìˆœì„œ ë°˜ì˜)
        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = "";

            data.forEach(person => {
                let row = `<tr>`;
                // ì´ë¦„ ì»¬ëŸ¼ (Sticky ì ìš©)
                row += `<td class="sticky-col team-${person.team}">${person.name}</td>`;
                
                // eventOrder ìˆœì„œëŒ€ë¡œ ë°ì´í„° ì¶œë ¥
                eventOrder.forEach(originalIndex => {
                    let eventKey = `event${originalIndex + 1}`;
                    let record = person[eventKey] || "-";
                    row += `<td>${record}</td>`;
                });

                row += `</tr>`;
                tableBody.innerHTML += row;
            });
        }

        function sortTable(key) {
            if (key === 'name') {
                currentData.sort((a, b) => a.name.localeCompare(b.name));
            } else {
                currentData.sort((a, b) => {
                    let valA = a[key];
                    let valB = b[key];
                    
                    if (!valA) return 1; 
                    if (!valB) return -1;
                    if (valA === "RETIRE") return 1;
                    if (valB === "RETIRE") return -1;
                    if (valA === "RETIRE" && valB === "RETIRE") return 0;
                    
                    return parseFloat(valA) - parseFloat(valB);
                });
            }
            renderTable(currentData);
        }

        async function saveRecord() {
            const name = document.getElementById('inputNameSelect').value;
            const event = document.getElementById('inputEventSelect').value;
            let recordInput = document.getElementById('inputRecord');
            let record = recordInput.value.trim();

            if (!name) return alert("ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

            const playerInfo = defaultPlayers.find(p => p.name === name);
            const team = playerInfo ? playerInfo.team : "brown";

            if (record === "") {
                record = null;
            } else if (record.toUpperCase() === "RETIRE") {
                record = "RETIRE";
            } else {
                if(!isNaN(record)) {
                    record = parseFloat(record).toFixed(2);
                } else {
                    return alert("ìˆ«ì ë˜ëŠ” RETIREë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                }
            }

            const userRef = ref(db, currentWeek + '/' + name);

            get(userRef).then((snapshot) => {
                let newData = {};
                if (snapshot.exists()) {
                    newData = snapshot.val();
                } else {
                    newData = { name: name, team: team };
                }

                if (record === null) {
                    delete newData[event];
                } else {
                    newData[event] = record;
                }
                newData.team = team;

                set(userRef, newData).then(() => {
                    loadData();
                    recordInput.value = ""; 
                    recordInput.focus(); 
                }).catch((error) => {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
                });
            });
        }

        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        initUI();
        loadData();
    </script>
</body>
</html>
